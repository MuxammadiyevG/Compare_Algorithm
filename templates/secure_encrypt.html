{% extends "base.html" %}

{% block title %}Xavfsiz Shifrlash - Intellektual Audit{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">
            <i class="fas fa-shield-alt text-primary mr-3"></i>Xavfsiz Shifrlash
        </h1>
        <p class="text-gray-600 dark:text-gray-400">
            Fayllarni xotirada shifrlash - hech narsa diskda saqlanmaydi
        </p>
    </div>

    <!-- Info Card -->
    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6 mb-8">
        <div class="flex items-start">
            <i class="fas fa-info-circle text-blue-500 text-2xl mr-4 mt-1"></i>
            <div>
                <h3 class="text-lg font-semibold text-blue-900 dark:text-blue-100 mb-2">
                    Qanday ishlaydi?
                </h3>
                <ul class="text-blue-800 dark:text-blue-200 space-y-2">
                    <li><i class="fas fa-check mr-2"></i>Fayl faqat xotirada (RAM) shifrlanadi</li>
                    <li><i class="fas fa-check mr-2"></i>Har bir fayl uchun yangi tasodifiy session_key yaratiladi</li>
                    <li><i class="fas fa-check mr-2"></i>Session_key MASTER_KEY bilan o'raladi (key wrapping)</li>
                    <li><i class="fas fa-check mr-2"></i>Ikkita fayl yuklab olinadi: <code class="bg-blue-100 dark:bg-blue-800 px-2 py-1 rounded">.enc</code> va <code class="bg-blue-100 dark:bg-blue-800 px-2 py-1 rounded">.key</code></li>
                    <li><i class="fas fa-check mr-2"></i>Serverda hech qanday fayl saqlanmaydi</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Encryption Form -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
        <form id="encryptForm" enctype="multipart/form-data">
            <!-- Algorithm Selection -->
            <div class="mb-6">
                <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-3">
                    <i class="fas fa-cog mr-2"></i>Shifrlash Algoritmi
                </label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <label class="algorithm-card cursor-pointer">
                        <input type="radio" name="algorithm" value="AES" checked class="hidden peer">
                        <div class="p-6 border-2 border-gray-300 dark:border-gray-600 rounded-lg peer-checked:border-primary peer-checked:bg-primary/5 hover:border-primary/50 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-bold text-lg text-gray-900 dark:text-white">AES-256</h4>
                                <i class="fas fa-shield-alt text-green-500 text-xl"></i>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Yuqori xavfsizlik, tez ishlash</p>
                            <div class="mt-3 flex items-center text-xs text-gray-500">
                                <span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded">Tavsiya etiladi</span>
                            </div>
                        </div>
                    </label>

                    <label class="algorithm-card cursor-pointer">
                        <input type="radio" name="algorithm" value="Fernet" class="hidden peer">
                        <div class="p-6 border-2 border-gray-300 dark:border-gray-600 rounded-lg peer-checked:border-primary peer-checked:bg-primary/5 hover:border-primary/50 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-bold text-lg text-gray-900 dark:text-white">Fernet</h4>
                                <i class="fas fa-lock text-blue-500 text-xl"></i>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">AES + HMAC, yuqori yaxlitlik</p>
                            <div class="mt-3 flex items-center text-xs text-gray-500">
                                <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">Xavfsiz</span>
                            </div>
                        </div>
                    </label>

                    <label class="algorithm-card cursor-pointer">
                        <input type="radio" name="algorithm" value="ChaCha20" class="hidden peer">
                        <div class="p-6 border-2 border-gray-300 dark:border-gray-600 rounded-lg peer-checked:border-primary peer-checked:bg-primary/5 hover:border-primary/50 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-bold text-lg text-gray-900 dark:text-white">ChaCha20</h4>
                                <i class="fas fa-rocket text-purple-500 text-xl"></i>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Zamonaviy, juda tez</p>
                            <div class="mt-3 flex items-center text-xs text-gray-500">
                                <span class="bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 px-2 py-1 rounded">Zamonaviy</span>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- File Upload -->
            <div class="mb-6">
                <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-3">
                    <i class="fas fa-file-upload mr-2"></i>Fayl Tanlash
                </label>
                <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-primary transition-colors">
                    <input type="file" name="file" id="fileInput" class="hidden" required>
                    <label for="fileInput" class="cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600 dark:text-gray-400 mb-2">
                            Faylni bu yerga torting yoki <span class="text-primary font-semibold">tanlash uchun bosing</span>
                        </p>
                        <p class="text-sm text-gray-500">Maksimal hajm: 16 MB</p>
                    </label>
                    <div id="fileName" class="mt-4 text-sm text-gray-700 dark:text-gray-300 font-medium hidden"></div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-center">
                <button type="submit" id="encryptBtn" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 shadow-lg">
                    <i class="fas fa-lock mr-2"></i>Shifrlash
                </button>
            </div>
        </form>

        <!-- Results Section -->
        <div id="results" class="hidden mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full mb-4">
                    <i class="fas fa-check text-3xl text-green-600 dark:text-green-400"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                    Shifrlash Muvaffaqiyatli!
                </h3>
                <p class="text-gray-600 dark:text-gray-400" id="resultMessage"></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="downloadFile('data')" class="block w-full p-6 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all transform hover:scale-105 shadow-lg cursor-pointer">
                    <div class="flex items-center justify-between">
                        <div class="text-left">
                            <h4 class="font-bold text-lg mb-1">Shifrlangan Fayl</h4>
                            <p class="text-sm opacity-90" id="encFileName">encrypted_data.enc</p>
                        </div>
                        <i class="fas fa-download text-3xl"></i>
                    </div>
                </button>

                <button onclick="downloadFile('key')" class="block w-full p-6 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:from-purple-600 hover:to-purple-700 transition-all transform hover:scale-105 shadow-lg cursor-pointer">
                    <div class="flex items-center justify-between">
                        <div class="text-left">
                            <h4 class="font-bold text-lg mb-1">Shifrlangan Kalit</h4>
                            <p class="text-sm opacity-90" id="keyFileName">encrypted_key.bin</p>
                        </div>
                        <i class="fas fa-key text-3xl"></i>
                    </div>
                </button>
            </div>

            <div class="mt-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                <div class="flex items-start">
                    <i class="fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-500 text-xl mr-3 mt-1"></i>
                    <div class="text-sm text-yellow-800 dark:text-yellow-200">
                        <p class="font-semibold mb-1">Muhim!</p>
                        <p>Ikkala faylni ham saqlang. Deshifrlash uchun ikkalasi ham kerak bo'ladi.</p>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-center">
                <button onclick="location.reload()" class="text-primary hover:text-primary/80 font-semibold">
                    <i class="fas fa-redo mr-2"></i>Yana Shifrlash
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const encryptForm = document.getElementById('encryptForm');
    const encryptBtn = document.getElementById('encryptBtn');
    const results = document.getElementById('results');
    const resultMessage = document.getElementById('resultMessage');

    // File input change handler
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            fileName.textContent = `Tanlangan: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            fileName.classList.remove('hidden');
        }
    });

    // Drag and drop
    const dropZone = document.querySelector('.border-dashed');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.add('border-primary', 'bg-primary/5');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.remove('border-primary', 'bg-primary/5');
        }, false);
    });

    dropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        
        if (files.length > 0) {
            const file = files[0];
            fileName.textContent = `Tanlangan: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            fileName.classList.remove('hidden');
        }
    }, false);

    // Form submission
    encryptForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(encryptForm);
        
        // Disable button and show loading
        encryptBtn.disabled = true;
        encryptBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Shifrlanmoqda...';

        try {
            const response = await fetch('{{ url_for("secure_encrypt") }}', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                resultMessage.textContent = `${data.filename} fayli ${data.algorithm} algoritmi bilan shifrlandi`;
                
                // Update filenames
                document.getElementById('encFileName').textContent = `${data.filename}.enc`;
                document.getElementById('keyFileName').textContent = `${data.filename}.key`;
                
                results.classList.remove('hidden');
                encryptForm.classList.add('hidden');
            } else {
                alert('Xatolik: ' + data.error);
                encryptBtn.disabled = false;
                encryptBtn.innerHTML = '<i class="fas fa-lock mr-2"></i>Shifrlash';
            }
        } catch (error) {
            alert('Xatolik yuz berdi: ' + error.message);
            encryptBtn.disabled = false;
            encryptBtn.innerHTML = '<i class="fas fa-lock mr-2"></i>Shifrlash';
        }
    });
    
    // Download function
    function downloadFile(type) {
        const url = type === 'data' 
            ? '{{ url_for("download_encrypted_data") }}' 
            : '{{ url_for("download_encrypted_key") }}';
        
        window.location.href = url;
    }
</script>
{% endblock %}
