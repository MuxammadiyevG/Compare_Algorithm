{% extends "base.html" %}

{% block title %}Xavfsiz Deshifrlash - Intellektual Audit{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">
            <i class="fas fa-unlock-alt text-primary mr-3"></i>Xavfsiz Deshifrlash
        </h1>
        <p class="text-gray-600 dark:text-gray-400">
            Shifrlangan fayllarni xotirada deshifrlash
        </p>
    </div>

    <!-- Info Card -->
    <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-6 mb-8">
        <div class="flex items-start">
            <i class="fas fa-info-circle text-green-500 text-2xl mr-4 mt-1"></i>
            <div>
                <h3 class="text-lg font-semibold text-green-900 dark:text-green-100 mb-2">
                    Deshifrlash Jarayoni
                </h3>
                <ul class="text-green-800 dark:text-green-200 space-y-2">
                    <li><i class="fas fa-check mr-2"></i>Shifrlangan fayl (.enc) va kalit faylini (.key) yuklang</li>
                    <li><i class="fas fa-check mr-2"></i>Kalit fayli MASTER_KEY bilan ochiladi</li>
                    <li><i class="fas fa-check mr-2"></i>Fayl xotirada (RAM) deshiflanadi</li>
                    <li><i class="fas fa-check mr-2"></i>Asl fayl yuklab olinadi</li>
                    <li><i class="fas fa-check mr-2"></i>Serverda hech qanday fayl saqlanmaydi</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Decryption Form -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
        <form id="decryptForm" enctype="multipart/form-data">
            <!-- Algorithm Selection -->
            <div class="mb-6">
                <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-3">
                    <i class="fas fa-cog mr-2"></i>Shifrlash Algoritmi
                </label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <label class="algorithm-card cursor-pointer">
                        <input type="radio" name="algorithm" value="AES" checked class="hidden peer">
                        <div class="p-6 border-2 border-gray-300 dark:border-gray-600 rounded-lg peer-checked:border-primary peer-checked:bg-primary/5 hover:border-primary/50 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-bold text-lg text-gray-900 dark:text-white">AES-256</h4>
                                <i class="fas fa-shield-alt text-green-500 text-xl"></i>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Yuqori xavfsizlik</p>
                        </div>
                    </label>

                    <label class="algorithm-card cursor-pointer">
                        <input type="radio" name="algorithm" value="Fernet" class="hidden peer">
                        <div class="p-6 border-2 border-gray-300 dark:border-gray-600 rounded-lg peer-checked:border-primary peer-checked:bg-primary/5 hover:border-primary/50 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-bold text-lg text-gray-900 dark:text-white">Fernet</h4>
                                <i class="fas fa-lock text-blue-500 text-xl"></i>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">AES + HMAC</p>
                        </div>
                    </label>

                    <label class="algorithm-card cursor-pointer">
                        <input type="radio" name="algorithm" value="ChaCha20" class="hidden peer">
                        <div class="p-6 border-2 border-gray-300 dark:border-gray-600 rounded-lg peer-checked:border-primary peer-checked:bg-primary/5 hover:border-primary/50 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-bold text-lg text-gray-900 dark:text-white">ChaCha20</h4>
                                <i class="fas fa-rocket text-purple-500 text-xl"></i>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Zamonaviy</p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Encrypted File Upload -->
            <div class="mb-6">
                <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-3">
                    <i class="fas fa-file-archive mr-2"></i>Shifrlangan Fayl (.enc)
                </label>
                <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-primary transition-colors">
                    <input type="file" name="encrypted_file" id="encryptedFileInput" class="hidden" required accept=".enc">
                    <label for="encryptedFileInput" class="cursor-pointer">
                        <i class="fas fa-file-archive text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600 dark:text-gray-400">
                            <span class="text-primary font-semibold">Shifrlangan faylni tanlang</span>
                        </p>
                    </label>
                    <div id="encryptedFileName" class="mt-3 text-sm text-gray-700 dark:text-gray-300 font-medium hidden"></div>
                </div>
            </div>

            <!-- Key File Upload -->
            <div class="mb-6">
                <label class="block text-gray-700 dark:text-gray-300 font-semibold mb-3">
                    <i class="fas fa-key mr-2"></i>Kalit Fayli (.key)
                </label>
                <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-primary transition-colors">
                    <input type="file" name="key_file" id="keyFileInput" class="hidden" required accept=".key">
                    <label for="keyFileInput" class="cursor-pointer">
                        <i class="fas fa-key text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600 dark:text-gray-400">
                            <span class="text-primary font-semibold">Kalit faylini tanlang</span>
                        </p>
                    </label>
                    <div id="keyFileName" class="mt-3 text-sm text-gray-700 dark:text-gray-300 font-medium hidden"></div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-center">
                <button type="submit" id="decryptBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105 shadow-lg">
                    <i class="fas fa-unlock mr-2"></i>Deshifrlash
                </button>
            </div>
        </form>

        <!-- Results Section -->
        <div id="results" class="hidden mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full mb-4">
                    <i class="fas fa-check text-3xl text-green-600 dark:text-green-400"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                    Deshifrlash Muvaffaqiyatli!
                </h3>
                <p class="text-gray-600 dark:text-gray-400" id="resultMessage"></p>
            </div>

            <div class="flex justify-center">
                <button onclick="downloadDecrypted()" class="inline-block p-8 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg cursor-pointer">
                    <div class="text-center">
                        <i class="fas fa-download text-5xl mb-4"></i>
                        <h4 class="font-bold text-xl mb-2">Asl Faylni Yuklab Olish</h4>
                        <p class="text-sm opacity-90">Deshifrlangan fayl tayyor</p>
                    </div>
                </button>
            </div>

            <div class="mt-6 text-center">
                <button onclick="location.reload()" class="text-primary hover:text-primary/80 font-semibold">
                    <i class="fas fa-redo mr-2"></i>Yana Deshifrlash
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Access -->
    <div class="mt-8 text-center">
        <a href="{{ url_for('secure_encrypt') }}" class="inline-flex items-center text-primary hover:text-primary/80 font-semibold">
            <i class="fas fa-arrow-left mr-2"></i>Shifrlash Sahifasiga Qaytish
        </a>
    </div>
</div>

<script>
    const encryptedFileInput = document.getElementById('encryptedFileInput');
    const keyFileInput = document.getElementById('keyFileInput');
    const encryptedFileName = document.getElementById('encryptedFileName');
    const keyFileName = document.getElementById('keyFileName');
    const decryptForm = document.getElementById('decryptForm');
    const decryptBtn = document.getElementById('decryptBtn');
    const results = document.getElementById('results');
    const resultMessage = document.getElementById('resultMessage');

    // Encrypted file input change handler
    encryptedFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            encryptedFileName.textContent = `Tanlangan: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            encryptedFileName.classList.remove('hidden');
        }
    });

    // Key file input change handler
    keyFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            keyFileName.textContent = `Tanlangan: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            keyFileName.classList.remove('hidden');
        }
    });

    // Form submission
    decryptForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(decryptForm);
        
        // Disable button and show loading
        decryptBtn.disabled = true;
        decryptBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deshiflanmoqda...';

        try {
            const response = await fetch('{{ url_for("secure_decrypt") }}', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                resultMessage.textContent = `Fayl ${data.algorithm} algoritmi bilan deshifrlandi`;
                results.classList.remove('hidden');
                decryptForm.classList.add('hidden');
            } else {
                alert('Xatolik: ' + data.error);
                decryptBtn.disabled = false;
                decryptBtn.innerHTML = '<i class="fas fa-unlock mr-2"></i>Deshifrlash';
            }
        } catch (error) {
            alert('Xatolik yuz berdi: ' + error.message);
            decryptBtn.disabled = false;
            decryptBtn.innerHTML = '<i class="fas fa-unlock mr-2"></i>Deshifrlash';
        }
    });
    
    // Download decrypted file
    function downloadDecrypted() {
        window.location.href = '{{ url_for("download_decrypted") }}';
    }
</script>
{% endblock %}
